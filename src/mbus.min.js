"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.JSON_PATH_TYPE=exports.bcd2dec=exports.bin2dec=exports.mbusDecoder=void 0;var definitions=[{name:"energy",units:"Wh",base:0,size:8,scalar:-3},{name:"energy",units:"J",base:8,size:8,scalar:0},{name:"volume",units:"m3",base:16,size:8,scalar:-6},{name:"mass",units:"kg",base:24,size:8,scalar:-3},{name:"on_time",units:"s",base:32,size:1,scalar:0},{name:"on_time",units:"min",base:33,size:1,scalar:0},{name:"on_time",units:"h",base:34,size:1,scalar:0},{name:"on_time",units:"days",base:35,size:1,scalar:0},{name:"operating_time",units:"s",base:36,size:1,scalar:0},{name:"operating_time",units:"min",base:37,size:1,scalar:0},{name:"operating_time",units:"h",base:38,size:1,scalar:0},{name:"operating_time",units:"days",base:39,size:1,scalar:0},{name:"power",units:"W",base:40,size:8,scalar:-3},{name:"power",units:"J/h",base:48,size:8,scalar:0},{name:"volume_flow",units:"m3/h",base:56,size:8,scalar:-6},{name:"volume_flow",units:"m3/min",base:64,size:8,scalar:-7},{name:"volume_flow",units:"m3/s",base:72,size:8,scalar:-9},{name:"mass_flow",units:"kg/h",base:80,size:8,scalar:-3},{name:"flow_temperature",units:"C",base:88,size:4,scalar:-3},{name:"return_temperature",units:"C",base:92,size:4,scalar:-3},{name:"temperature_difference",units:"K",base:96,size:4,scalar:-3},{name:"external_temperature",units:"C",base:100,size:4,scalar:-3},{name:"pressure",units:"bar",base:104,size:4,scalar:-3},{name:"avg_duration",units:"s",base:112,size:1,scalar:0},{name:"avg_duration",units:"min",base:113,size:1,scalar:0},{name:"avg_duration",units:"h",base:114,size:1,scalar:0},{name:"avg_duration",units:"days",base:115,size:1,scalar:0},{name:"actual_duration",units:"s",base:116,size:1,scalar:0},{name:"actual_duration",units:"min",base:117,size:1,scalar:0},{name:"actual_duration",units:"h",base:118,size:1,scalar:0},{name:"actual_duration",units:"days",base:119,size:1,scalar:0},{name:"fabrication_number",units:"",base:120,size:1,scalar:0},{name:"bus_address",units:"",base:122,size:1,scalar:0},{name:"credit",units:"",base:64768,size:4,scalar:-3},{name:"debit",units:"",base:64772,size:4,scalar:-3},{name:"access_number",units:"",base:64776,size:1,scalar:0},{name:"manufacturer",units:"",base:64778,size:1,scalar:0},{name:"model_version",units:"",base:64780,size:1,scalar:0},{name:"hardware_version",units:"",base:64781,size:1,scalar:0},{name:"firmware_version",units:"",base:64782,size:1,scalar:0},{name:"customer",units:"",base:64785,size:1,scalar:0},{name:"error_flags",units:"",base:64791,size:1,scalar:0},{name:"error_mask",units:"",base:64792,size:1,scalar:0},{name:"digital_output",units:"",base:64794,size:1,scalar:0},{name:"digital_input",units:"",base:64795,size:1,scalar:0},{name:"baudrate",units:"bps",base:64796,size:1,scalar:0},{name:"response_delay_time",units:"",base:64797,size:1,scalar:0},{name:"retry",units:"",base:64798,size:1,scalar:0},{name:"generic",units:"",base:64828,size:1,scalar:0},{name:"volts",units:"V",base:64832,size:16,scalar:-9},{name:"amperes",units:"A",base:64848,size:16,scalar:-12},{name:"reset_counter",units:"",base:64864,size:16,scalar:-12},{name:"cumulation_counter",units:"",base:64865,size:16,scalar:-12},{name:"energy",units:"Wh",base:64256,size:2,scalar:5},{name:"energy",units:"J",base:64264,size:2,scalar:8},{name:"volume",units:"m3",base:64272,size:2,scalar:2},{name:"mass",units:"kg",base:64280,size:2,scalar:5},{name:"volume",units:"ft3",base:64289,size:1,scalar:-1},{name:"volume",units:"gal",base:64290,size:2,scalar:-1},{name:"volume_flow",units:"gal/min",base:64292,size:1,scalar:-3},{name:"volume_flow",units:"gal/min",base:64293,size:1,scalar:0},{name:"volume_flow",units:"gal/h",base:64294,size:1,scalar:0},{name:"power",units:"W",base:64296,size:2,scalar:5},{name:"power",units:"J/h",base:64304,size:2,scalar:8},{name:"flow_temperature",units:"F",base:64344,size:4,scalar:-3},{name:"return_temperature",units:"F",base:64348,size:4,scalar:-3},{name:"temperature_difference",units:"F",base:64352,size:4,scalar:-3},{name:"external_temperature",units:"F",base:64356,size:4,scalar:-3},{name:"temperature_limit",units:"F",base:64368,size:4,scalar:-3},{name:"temperature_limit",units:"C",base:64372,size:4,scalar:-3},{name:"max_power",units:"W",base:64376,size:8,scalar:-3}];function bin2dec(stream){var value=0;for(var i=0;i<stream.length;i++){var byte=stream[stream.length-i-1];if(byte>255){throw"Byte value overflow!"}value=value<<8|byte}return value}function bcd2dec(stream){var value=0;for(var i=0;i<stream.length;i++){var byte=stream[stream.length-i-1];if(byte>255){throw"Byte value overflow!"}value=value*100+(byte>>4)*10+(byte&15)}return value}function mbusDecoder(bytes){console.log("mbusDecoder: ",bytes);var fields=[];var index=0;var value=0;while(index<bytes.length){var dif=bytes[index++];var bcd=(dif&8)===8;var len=dif&7;if(len<1||4<len){throw"Unsupported coding: "+(dif&15)}var vif=0;do{if(index===bytes.length){throw"Buffer overflow"}vif=vif<<8|bytes[index++]}while((vif&128)===128);var def=-1;for(var i=0;i<definitions.length;i++){var tmp=definitions[i];if(tmp.base<=vif&&vif<tmp.base+tmp.size){def=i;break}}if(def<0)throw"Unsupported VIF: "+vif;var definition=definitions[def];if(index+len>bytes.length)throw"Buffer overflow";switch(true){case manufacturer.base==64778:let number=bytes.slice(index,index+len)&32767;let arr=[(number>>10)+64,(number>>5&31)+64,(number&31)+64];value=String.fromCharCode.apply(null,arr);break;case bcd==true:value=bcd2dec(bytes.slice(index,index+len));break;default:value=bin2dec(bytes.slice(index,index+len));break}index+=len;var scalar=definition.scalar+vif-definition.base;var scaled=value*Math.pow(10,scalar);fields.push({index:fields.length+1,vif:vif,name:definition.name,units:definition.units,value:scaled})}return fields}